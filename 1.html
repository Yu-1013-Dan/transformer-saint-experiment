<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HENN 模型核心阶段架构图</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f9fafb; /* 使用柔和的背景色 */
            padding: 20px;
            box-sizing: border-box;
            color: #374151; /* 默认文字颜色 */
        }
        .container {
            text-align: center;
            max-width: 95%;
            width: 850px; /* 稍微增加宽度以获得更好的布局 */
            background-color: #ffffff;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05), 0 4px 10px rgba(0,0,0,0.02);
        }
        h2 {
            font-size: 1.6em;
            font-weight: 600;
            color: #111827;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        .mermaid {
            width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>图X: HENN核心阶段 (HENN Core Stage) 内部架构</h2>
        
        <div class="mermaid">
            graph TD
                %% 定义样式
                classDef inputOutput fill:#f9fafb,stroke:#9ca3af,stroke-width:1.5px,stroke-dasharray: 3 3;
                classDef selfAttnBlock fill:#eff6ff,stroke:#60a5fa,stroke-width:1.5px,color:#1e3a8a;
                classDef knnAttnBlock fill:#f0fdf4,stroke:#4ade80,stroke-width:1.5px,color:#166534;
                classDef innovationStep fill:#fefce8,stroke:#facc15,stroke-width:1.5px,color:#713f12;

                %% 整体外框
                subgraph A[HENN Stage (可重复L次)]
                    direction TB

                    %% 输入
                    A_Input["<b>Embedded inputs of a batch</b><br/><i>(批次数据的混合嵌入)</i>"]:::inputOutput
                    
                    A_Input --> SelfAttentionBlock;
                    
                    %% 自注意力模块
                    subgraph SelfAttentionBlock [样本内自注意力模块 (Self-Attention Block)]
                        style SelfAttentionBlock fill:#eff6ff,stroke:#60a5fa,stroke-width:1px,color:#1e3a8a
                        
                        SA1["Multi-Head<br/>Self-Attention"] --> SA2["Add & Norm"];
                        SA2 --> SA3["FeedForward"];
                        SA3 --> SA4["Add & Norm"];
                    end
                    
                    SA4 --> KnnAttentionBlock;

                    %% k-NN跨样本注意力模块 (您的创新)
                    subgraph KnnAttentionBlock [k-NN 跨样本注意力模块 (k-NN Intersample Attention Block)]
                        style KnnAttentionBlock fill:#f0fdf4,stroke:#4ade80,stroke-width:1px,color:#166534

                        subgraph KnnFlow [内部流程]
                            direction TB
                            S1("<b>A. 提取样本表示</b><br/>(Extract Sample Representation)<br/>e.g., [CLS] Token / Avg Pool"):::innovationStep
                            S1 --> S2("<b>B. 计算k-NN图</b><br/>(Calculate k-NN Graph)<br/>基于相似度找到Top-k邻居"):::innovationStep;
                            S2 --> S3("<b>C. 生成稀疏掩码</b><br/>(Generate Sparse Mask)<br/>只允许关注自身及k个邻居"):::innovationStep;
                            S3 --> S4("<b>D. 带掩码的多头注意力</b><br/>(Masked Multi-Head Attention)"):::innovationStep;
                        end
                    end

                    KnnAttentionBlock --> A_Output["<b>Contextual representations of a batch</b><br/><i>(上下文感知的批次表示)</i>"]:::inputOutput;
                end
        </div>
    </div>

    <!-- 
      修复部分: 更改JavaScript加载方式 
      不再使用 type="module" 和 import, 而是使用更传统的 <script src="..."> 方式
    -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                'primaryColor': '#ffffff',
                'primaryTextColor': '#333',
                'primaryBorderColor': '#d1d5db',
                'lineColor': '#4b5563',
                'textColor': '#1f2937',
                'fontSize': '16px'
            }
        });
    </script>
</body>
</html>